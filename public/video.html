<!DOCTYPE html>
<html lang="ca">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video de la ciudad</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background-color: #fff;
        margin: 0;
        color: #000;
      }
      .content-container {
        display: flex;
        width: 90%;
        max-width: 1200px;
        gap: 20px;
        margin: 20px auto;
      }
      .video-container {
        flex: 1;
        min-width: 0;
      }
      .transcript-container {
        flex: 1;
        min-width: 300px;
        max-height: 450px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      .current-explanation {
        font-weight: bold;
        color: #0066cc;
        padding: 8px;
        border-radius: 4px;
        background-color: #e6f2ff;
        margin-bottom: 10px;
      }
      .explanation-title {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1em;
      }
      .back-link {
        color: #000;
        text-decoration: none;
        margin-top: 20px;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <header>
      <h1 id="cityName">Video de la ciudad</h1>
    </header>
    <div class="content-container">
      <div class="video-container">
        <video id="videoPlayer" controls width="100%" height="450">
          Tu navegador no soporta la reproducción de video.
        </video>
      </div>
      <div class="transcript-container">
        <div class="explanation-title">Explicación:</div>
        <div id="transcriptText">Cargando explicación...</div>
      </div>
    </div>
    <a class="back-link" href="index.html">← Volver a la página principal</a>

    <script>
      // Obtener parámetros de la URL
      const params = new URLSearchParams(window.location.search);
      const city = params.get("city");

      let videoURL = "";
      let title = "Video de la ciudad";
      let vttURL = "";
      
      // Array para almacenar los segmentos de explicación
      let explanationSegments = [];

      switch (city) {
        case "madrid":
          videoURL = "videos/madrid/videoMadrid.mp4";
          vttURL = "vtts/madrid/explicacionesMadrid.vtt";
          title = "Video de Madrid";
          const track = document.createElement("track");
          track.kind = "captions";
          track.label = "Español";
          track.srclang = "es";
          track.src = "vtts/madrid/subtitulosMadrid.vtt";
          track.default = true;
          videoPlayer.appendChild(track);
          break;
          
        case "barcelona":
          videoURL = "";
          vttURL = "vtts/barcelona/explicacionesBarcelona.vtt";
          title = "Video de Barcelona";
          break;
        case "valencia":
          videoURL = "";
          vttURL = "vtts/valencia/explicacionesValencia.vtt";
          title = "Video de Valencia";
          break;
        case "palma":
          videoURL = "";
          vttURL = "vtts/palma/explicacionesPalma.vtt";
          title = "Video de Palma";
          break;
        default:
          videoURL = "";
          title = "Video no encontrado";
      }

      // Asignar la URL al elemento de video
      document.getElementById("videoPlayer").src = videoURL;
      document.getElementById("cityName").textContent = title;
      
      // Función para convertir tiempo en formato "00:00:00.000" a segundos
      function timeToSeconds(timeString) {
        const parts = timeString.split(':');
        let seconds = 0;
        
        if (parts.length === 3) {
          // Formato HH:MM:SS.mmm
          const [hours, minutes, secondsMs] = parts;
          const [secs, ms] = secondsMs.split('.');
          seconds = parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(secs);
          if (ms) seconds += parseInt(ms) / 1000;
        } else if (parts.length === 2) {
          // Formato MM:SS.mmm
          const [minutes, secondsMs] = parts;
          const [secs, ms] = secondsMs.split('.');
          seconds = parseInt(minutes) * 60 + parseInt(secs);
          if (ms) seconds += parseInt(ms) / 1000;
        }
        
        return seconds;
      }

      // Cargar y parsear el archivo VTT
      async function loadVTTContent() {
        const transcriptElement = document.getElementById("transcriptText");
        
        if (!vttURL) {
          transcriptElement.textContent = "Explicación no disponible";
          return;
        }

        try {
          transcriptElement.textContent = `Intentando cargar: ${vttURL}`;
          console.log(`Intentando cargar archivo VTT desde: ${vttURL}`);
          
          const response = await fetch(vttURL);
          if (!response.ok) {
            const errorMsg = `Error al cargar el archivo VTT: ${response.status} ${response.statusText}`;
            console.error(errorMsg);
            transcriptElement.textContent = errorMsg;
            throw new Error(errorMsg);
          }

          console.log("Archivo VTT cargado correctamente");
          const text = await response.text();
          console.log("Contenido del archivo VTT:", text.substring(0, 100) + "...");
          
          const lines = text.split("\n");
          console.log(`Número de líneas en el archivo: ${lines.length}`);
          
          // Parsear el archivo VTT
          let currentSegment = null;
          explanationSegments = []; // Reiniciar el array de segmentos
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // Saltar líneas vacías y la cabecera WEBVTT
            if (line === "" || line === "WEBVTT") continue;
            
            // Saltar números de cue
            if (/^\d+$/.test(line)) continue;
            
            // Comprobar si es una línea de tiempo
            if (line.includes("-->")) {
              const [startTime, endTime] = line.split("-->").map(t => t.trim());
              currentSegment = {
                start: timeToSeconds(startTime),
                end: timeToSeconds(endTime),
                text: ""
              };
              console.log(`Nuevo segmento: ${startTime} --> ${endTime}`);
              continue;
            }
            
            // Si tenemos un segmento actual y esta línea no es de tiempo, es texto
            if (currentSegment) {
              if (currentSegment.text) {
                currentSegment.text += " " + line;
              } else {
                currentSegment.text = line;
              }
              
              // Si la siguiente línea es vacía o de tiempo, guardamos este segmento
              if (i + 1 >= lines.length || lines[i + 1].trim() === "" || lines[i + 1].includes("-->") || /^\d+$/.test(lines[i + 1].trim())) {
                explanationSegments.push(currentSegment);
                console.log(`Segmento añadido: ${currentSegment.start}-${currentSegment.end}: "${currentSegment.text.substring(0, 30)}..."`);
                currentSegment = null;
              }
            }
          }
          
          console.log(`Total de segmentos encontrados: ${explanationSegments.length}`);
          
          // Mostrar mensaje inicial
          if (explanationSegments.length > 0) {
            transcriptElement.innerHTML = "<div>Reproduciendo el video para ver la explicación...</div>";
            console.log("Listo para mostrar explicaciones durante la reproducción");
          } else {
            transcriptElement.textContent = "No se encontraron explicaciones en el archivo";
            console.log("No se encontraron segmentos de explicación en el archivo");
          }
          
        } catch (error) {
          const errorMsg = `Error al cargar la explicación: ${error.message}`;
          transcriptElement.textContent = errorMsg;
          console.error(errorMsg);
        }
      }
      
      // Función para actualizar la explicación según el tiempo actual del video
      function updateExplanation(currentTime) {
        const transcriptElement = document.getElementById("transcriptText");
        let currentExplanation = null;
        
        // Buscar el segmento que corresponde al tiempo actual
        for (const segment of explanationSegments) {
          if (currentTime >= segment.start && currentTime <= segment.end) {
            currentExplanation = segment;
            break;
          }
        }
        
        // Actualizar el texto de la explicación
        if (currentExplanation) {
          transcriptElement.innerHTML = `<div class="current-explanation">${currentExplanation.text}</div>`;
        } else {
          // Si no hay explicación para este momento, mostrar un mensaje
          transcriptElement.innerHTML = "<div>No hay explicación para este momento del video</div>";
        }
      }

      // Obtener el elemento de video
      const videoPlayer = document.getElementById("videoPlayer");
      
      // Añadir event listener para actualizar la explicación durante la reproducción
      videoPlayer.addEventListener("timeupdate", function() {
        if (explanationSegments.length > 0) {
          updateExplanation(this.currentTime);
        }
      });
      
      // Añadir event listener para cuando el video esté listo
      videoPlayer.addEventListener("loadeddata", function() {
        console.log("Video cargado correctamente");
        // Intentar cargar las explicaciones después de que el video esté listo
        if (explanationSegments.length === 0) {
          loadVTTContent();
        }
      });

      // Cargar el contenido VTT cuando se cargue la página
      loadVTTContent();
    </script>
  </body>
</html>
